<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #fafafa;
            --foreground: #0a0a0a;
            --card: #ffffff;
            --card-foreground: #0a0a0a;
            --primary: #3b82f6;
            --primary-foreground: #ffffff;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --destructive: #ef4444;
            --destructive-foreground: #ffffff;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #3b82f6;
            --radius: 1rem;
        }

        [data-theme="dark"] {
            --background: #0a0a0a;
            --foreground: #fafafa;
            --card: #0a0a0a;
            --card-foreground: #fafafa;
            --primary: #60a5fa;
            --primary-foreground: #ffffff;
            --secondary: #1e293b;
            --secondary-foreground: #fafafa;
            --muted: #1e293b;
            --muted-foreground: #94a3b8;
            --accent: #1e293b;
            --accent-foreground: #fafafa;
            --destructive: #7f1d1d;
            --destructive-foreground: #fafafa;
            --border: #1e293b;
            --input: #1e293b;
            --ring: #60a5fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        /* Neumorphic styles */
        .neumorphic-card {
            background: var(--background);
            border-radius: var(--radius);
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.1), -8px -8px 16px rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        [data-theme="dark"] .neumorphic-card {
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.3), -8px -8px 16px rgba(255, 255, 255, 0.05);
        }

        .neumorphic-button {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 4px);
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 0.5rem 1rem;
            color: var(--foreground);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .neumorphic-button:hover {
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1), -3px -3px 6px rgba(255, 255, 255, 0.8);
        }

        .neumorphic-button:active {
            box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .neumorphic-button {
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .neumorphic-button:hover {
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3), -3px -3px 6px rgba(255, 255, 255, 0.05);
        }

        .neumorphic-input {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 4px);
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.8);
            padding: 0.5rem 0.75rem;
            color: var(--foreground);
            font-size: 0.875rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .neumorphic-input {
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.03);
        }

        .neumorphic-input:focus {
            outline: none;
            ring: 2px solid var(--ring);
        }

        .primary-button {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
        }

        .destructive-button {
            background: var(--destructive);
            color: var(--destructive-foreground);
            border: none;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
        }

        .title .accent {
            color: var(--primary);
        }

        /* Tabs */
        .tabs {
            margin-bottom: 2rem;
        }

        .tab-list {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            background: var(--background);
            padding: 0.5rem;
            border-radius: var(--radius);
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }

        [data-theme="dark"] .tab-list {
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(255, 255, 255, 0.05);
        }

        .tab-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--muted-foreground);
            border-radius: calc(var(--radius) - 4px);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .tab-button.active {
            background: var(--primary);
            color: var(--primary-foreground);
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1), -3px -3px 6px rgba(255, 255, 255, 0.8);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Grid layouts */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr;
            }
            .tab-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Card */
        .card {
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--foreground);
        }

        .select {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 4px);
            padding: 0.5rem 0.75rem;
            color: var(--foreground);
            font-size: 0.875rem;
            width: 100%;
            cursor: pointer;
        }

        .textarea {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: calc(var(--radius) - 4px);
            padding: 0.5rem 0.75rem;
            color: var(--foreground);
            font-size: 0.875rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        /* Utility classes */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-muted {
            color: var(--muted-foreground);
        }

        .text-primary {
            color: var(--primary);
        }

        .text-destructive {
            color: var(--destructive);
        }

        .text-green {
            color: #22c55e;
        }

        .text-red {
            color: #ef4444;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--background);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted-foreground);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }

        .animate-slideDown {
            animation: slideDown 0.3s ease-in-out;
        }

        /* Icons */
        .icon {
            width: 1rem;
            height: 1rem;
            display: inline-block;
        }

        /* Theme toggle */
        .theme-toggle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Status indicators */
        .status-low {
            border: 2px solid var(--destructive);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-income {
            background: #dcfce7;
            color: #166534;
        }

        .badge-expense {
            background: #fee2e2;
            color: #991b1b;
        }

        [data-theme="dark"] .badge-income {
            background: #14532d;
            color: #bbf7d0;
        }

        [data-theme="dark"] .badge-expense {
            background: #7f1d1d;
            color: #fecaca;
        }

        /* Calendar styles */
        .calendar {
            background: var(--background);
            border-radius: var(--radius);
            padding: 1rem;
        }

        .calendar-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background: var(--accent);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .calendar-day.today {
            background: var(--accent);
            font-weight: 600;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--muted-foreground);
        }

        .empty-state .icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>

  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>

<script>
  if (window.matchMedia('(display-mode: standalone)').matches && location.pathname.endsWith('/')) {
    location.replace(location.pathname + 'index.html');
  }
</script>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">–ê–≤—Ç–æ<span class="accent">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span></h1>
            <button class="neumorphic-button theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
        </div>

        <div class="tabs">
            <div class="tab-list">
                <button class="tab-button active" onclick="showTab('warehouse', event)">
                    –°–∫–ª–∞–¥
                </button>
                <button class="tab-button" onclick="showTab('repair', event)">
                    –†–µ–º–æ–Ω—Ç
                </button>
                <button class="tab-button" onclick="showTab('materials', event)">
                    –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
                </button>
                <button class="tab-button" onclick="showTab('history', event)">
                    –ò—Å—Ç–æ—Ä–∏—è
                </button>
                <button class="tab-button" onclick="showTab('finance', event)">
                    –§–∏–Ω–∞–Ω—Å—ã
                </button>
                <button class="tab-button" onclick="showTab('settings', event)">
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>

            <!-- Warehouse Tab -->
            <div id="warehouse" class="tab-content active">
                <div class="card-header">
                    <h2 class="text-xl font-semibold">–°–∫–ª–∞–¥ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
                    <button class="neumorphic-button primary-button" onclick="showAddWarehouseItemModal()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                    </button>
                </div>
                <div id="warehouse-items" class="grid grid-cols-3 gap-4"></div>
            </div>

            <!-- Repair Tab -->
            <div id="repair" class="tab-content">
                <div class="card-header">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        üöó –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–µ–º–æ–Ω—Ç–∞
                    </h2>
                    <div class="flex gap-2">
                        <button class="neumorphic-button" onclick="clearRepair()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        <button class="neumorphic-button primary-button" onclick="saveRepair()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–º–æ–Ω—Ç</button>
                    </div>
                </div>
                
                <div class="grid gap-6">
                    <!-- Client Info -->
                    <div class="neumorphic-card card">
                        <h3 class="font-medium mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                                <input type="text" id="client-name" class="neumorphic-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
                            </div>
                            <div class="form-group">
                                <label class="label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ</label>
                                <input type="text" id="car-info" class="neumorphic-input" placeholder="–ú–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å, –≥–æ–¥">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</label>
                            <textarea id="repair-description" class="textarea" placeholder="–û–ø–∏—à–∏—Ç–µ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ —Ä–∞–±–æ—Ç—ã" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Add Materials -->
                    <div class="neumorphic-card card">
                        <h3 class="font-medium mb-4">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                        <div id="available-materials" class="grid grid-cols-3 gap-3"></div>
                    </div>

                    <!-- Selected Materials -->
                    <div id="selected-materials-section" class="neumorphic-card card hidden">
                        <h3 class="font-medium mb-4">–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                        <div id="selected-materials" class="grid gap-3"></div>
                    </div>

                    <!-- Labor Cost -->
                    <div class="neumorphic-card card">
                        <h3 class="font-medium mb-4">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç</h3>
                        <div class="form-group">
                            <label class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç</label>
                            <input type="number" id="labor-cost" class="neumorphic-input" placeholder="0.00" step="0.01">
                        </div>
                    </div>

                    <!-- Total Cost -->
                    <div id="total-cost-section" class="neumorphic-card card hidden">
                        <h3 class="font-medium mb-4">–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                        <div class="grid gap-2">
                            <div class="flex justify-between">
                                <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</span>
                                <span id="total-materials-cost">0 ‚ÇΩ</span>
                            </div>
                            <div class="flex justify-between">
                                <span>–†–∞–±–æ—Ç—ã:</span>
                                <span id="total-labor-cost">0 ‚ÇΩ</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg text-primary" style="border-top: 1px solid var(--border); padding-top: 0.5rem;">
                                <span>–ò—Ç–æ–≥–æ:</span>
                                <span id="total-repair-cost">0 ‚ÇΩ</span>
                            </div>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button class="neumorphic-button primary-button" onclick="showReceiptModal()">
                                üßæ –ü–æ–∫–∞–∑–∞—Ç—å —á–µ–∫
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div id="materials" class="tab-content">
                <div class="card-header">
                    <h2 class="text-xl font-semibold">–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
                    <div class="flex gap-2">
                        <button class="neumorphic-button primary-button" onclick="showAddMaterialModal()">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                        </button>
                        <button class="neumorphic-button primary-button" onclick="showSaveCalculationModal()">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç
                        </button>
                    </div>
                </div>
                <div id="materials-list" class="grid grid-cols-3 gap-4"></div>
                <div id="materials-total" class="neumorphic-card card mt-6 hidden">
                    <div class="flex justify-between items-center">
                        <h3 class="font-medium">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</h3>
                        <span id="materials-total-amount" class="text-xl font-bold text-primary">0 ‚ÇΩ</span>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <h2 class="text-xl font-semibold mb-6">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ —Ä–µ–º–æ–Ω—Ç–æ–≤</h2>
                
                <div id="repairs-history-section">
                    <h3 class="text-lg font-semibold mb-4">–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–æ–≤</h3>
                    <div id="repairs-history" class="grid grid-cols-3 gap-4 mb-8"></div>
                </div>

                <div id="calculations-history-section">
                    <h3 class="text-lg font-semibold mb-4">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h3>
                    <div id="calculations-history" class="grid grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- Finance Tab -->
            <div id="finance" class="tab-content">
                <div class="card-header">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á–µ—Ç
                    </h2>
                    <div class="flex gap-2">
                        <button class="neumorphic-button" onclick="importRepairIncome()">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ä–µ–º–æ–Ω—Ç–æ–≤</button>
                        <button class="neumorphic-button primary-button" onclick="showAddTransactionModal()">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                        </button>
                    </div>
                </div>

                <!-- Monthly Overview -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="neumorphic-card card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-muted">–î–æ—Ö–æ–¥—ã</p>
                                <p id="monthly-income" class="text-2xl font-bold text-green">0 ‚ÇΩ</p>
                            </div>
                            <span class="text-2xl">üìà</span>
                        </div>
                    </div>
                    <div class="neumorphic-card card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-muted">–†–∞—Å—Ö–æ–¥—ã</p>
                                <p id="monthly-expenses" class="text-2xl font-bold text-red">0 ‚ÇΩ</p>
                            </div>
                            <span class="text-2xl">üìâ</span>
                        </div>
                    </div>
                    <div class="neumorphic-card card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-muted">–ü—Ä–∏–±—ã–ª—å</p>
                                <p id="monthly-profit" class="text-2xl font-bold text-primary">0 ‚ÇΩ</p>
                            </div>
                            <span class="text-2xl">üí∞</span>
                        </div>
                    </div>
                    <div class="neumorphic-card card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-muted">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
                                <p id="monthly-transactions" class="text-2xl font-bold">0</p>
                            </div>
                            <span class="text-2xl">üìÑ</span>
                        </div>
                    </div>
                </div>

                <!-- Month Selector and Calendar -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="neumorphic-card card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium">–û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü</h3>
                            <div class="flex items-center gap-2">
                                <button class="neumorphic-button" onclick="changeMonth(-1)">‚Äπ</button>
                                <span id="current-month" class="font-medium"></span>
                                <button class="neumorphic-button" onclick="changeMonth(1)">‚Ä∫</button>
                            </div>
                        </div>
                        <div id="category-stats" class="grid gap-4"></div>
                    </div>

                    <div class="neumorphic-card card">
                        <h3 class="font-medium mb-4">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ <span id="selected-date-display"></span></h3>
                        <div class="calendar mb-4">
                            <div id="calendar-grid" class="calendar-grid"></div>
                        </div>
                        <div id="daily-transactions" class="grid gap-3" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 class="text-xl font-semibold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div class="neumorphic-card card">
                    <div class="grid gap-6">
                        <div>
                            <h3 class="text-lg font-medium mb-4">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="label">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</label>
                                    <p class="text-sm text-muted">–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–≤–µ—Ç–ª–æ–π –∏ —Ç–µ–º–Ω–æ–π —Ç–µ–º–æ–π</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="dark-theme-toggle" onchange="toggleTheme()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                            <h3 class="text-lg font-medium mb-4">–ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
                            <div class="grid gap-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="label">–ï–¥–∏–Ω–∏—Ü—ã –∂–∏–¥–∫–æ—Å—Ç–∏</label>
                                        <p class="text-sm text-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏—Ç—Ä—ã –≤–º–µ—Å—Ç–æ –º–∏–ª–ª–∏–ª–∏—Ç—Ä–æ–≤</p>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="use-liters" onchange="updateSettings()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="label">–ï–¥–∏–Ω–∏—Ü—ã –≤–µ—Å–∞</label>
                                        <p class="text-sm text-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∏–ª–æ–≥—Ä–∞–º–º—ã –≤–º–µ—Å—Ç–æ –≥—Ä–∞–º–º–æ–≤</p>
                                    </div>
                                    <label class="switch">
                                        <input type="checkbox" id="use-kilograms" onchange="updateSettings()">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                            <h3 class="text-lg font-medium mb-4">–í–∞–ª—é—Ç–∞</h3>
                            <div class="form-group">
                                <label class="label">–í–∞–ª—é—Ç–∞</label>
                                <select id="currency-select" class="select" onchange="updateSettings()">
                                    <option value="RUB">–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (‚ÇΩ)</option>
                                    <option value="USD">–î–æ–ª–ª–∞—Ä –°–®–ê ($)</option>
                                    <option value="EUR">–ï–≤—Ä–æ (‚Ç¨)</option>
                                    <option value="KZT">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ (‚Ç∏)</option>
                                    <option value="BYN">–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —Ä—É–±–ª—å (Br)</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex justify-end" style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                            <button class="neumorphic-button primary-button" onclick="saveSettings()">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be inserted here by JavaScript -->
    <div id="modal-container"></div>

    <style>
        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--muted);
            transition: .4s;
            border-radius: 34px;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.1), inset -2px -2px 4px rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .slider {
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2), inset -2px -2px 4px rgba(255, 255, 255, 0.03);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--background);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1), -2px -2px 4px rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .slider:before {
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2), -2px -2px 4px rgba(255, 255, 255, 0.03);
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>

    <script>
        // Global state
        let currentTheme = localStorage.getItem('theme') || 'light';
        let settings = JSON.parse(localStorage.getItem('app-settings')) || {
            useLiters: false,
            useKilograms: false,
            currency: 'RUB'
        };
        let warehouseItems = JSON.parse(localStorage.getItem('warehouse-items')) || [];
        let materials = JSON.parse(localStorage.getItem('materials')) || [];
        let calculations = JSON.parse(localStorage.getItem('calculations')) || [];
        let repairs = JSON.parse(localStorage.getItem('repairs')) || [];
        let transactions = JSON.parse(localStorage.getItem('finance-transactions')) || [];
        let currentRepair = {
            clientName: '',
            carInfo: '',
            description: '',
            materials: [],
            laborCost: 0,
            totalMaterialsCost: 0,
            totalCost: 0
        };
        let selectedDate = new Date();
        let currentMonth = new Date();
        let editingMaterialId = null;
        let editingWarehouseItemId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadSettings();
            renderWarehouseItems();
            renderMaterials();
            renderCalculationsHistory();
            renderRepairsHistory();
            renderAvailableMaterials();
            updateFinanceOverview();
            renderCalendar();
            updateSelectedDateDisplay();
        });

        // Theme management
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-icon').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('dark-theme-toggle').checked = currentTheme === 'dark';
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-icon').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('dark-theme-toggle').checked = currentTheme === 'dark';
            localStorage.setItem('theme', currentTheme);
        }

        // Tab management
        function showTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');

            // Refresh data when switching to certain tabs
            if (tabName === 'finance') {
                updateFinanceOverview();
                renderCalendar();
            } else if (tabName === 'repair') {
                renderAvailableMaterials();
            }
        }

        // Settings management
        function loadSettings() {
            document.getElementById('use-liters').checked = settings.useLiters;
            document.getElementById('use-kilograms').checked = settings.useKilograms;
            document.getElementById('currency-select').value = settings.currency;
        }

        function updateSettings() {
            settings.useLiters = document.getElementById('use-liters').checked;
            settings.useKilograms = document.getElementById('use-kilograms').checked;
            settings.currency = document.getElementById('currency-select').value;
            localStorage.setItem('app-settings', JSON.stringify(settings));
            
            // Re-render components that depend on settings
            renderWarehouseItems();
            renderMaterials();
            renderCalculationsHistory();
            renderRepairsHistory();
            updateFinanceOverview();
        }

        function saveSettings() {
            updateSettings();
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }

        // Utility functions
        function formatCurrency(value) {
            const currencySymbols = {
                'RUB': '‚ÇΩ',
                'USD': '$',
                'EUR': '‚Ç¨',
                'KZT': '‚Ç∏',
                'BYN': 'Br'
            };
            return `${value.toFixed(2)} ${currencySymbols[settings.currency] || '‚ÇΩ'}`;
        }

        function getUnitLabel(type) {
            switch (type) {
                case 'liquid':
                    return settings.useLiters ? '–ª' : '–º–ª';
                case 'weight':
                    return settings.useKilograms ? '–∫–≥' : '–≥';
                case 'piece':
                    return '—à—Ç';
                default:
                    return '';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--background);
                color: var(--foreground);
                padding: 1rem 1.5rem;
                border-radius: var(--radius);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                z-index: 1001;
                animation: slideIn 0.3s ease;
                border-left: 4px solid ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Modal management
        function showModal(title, content, actions = '') {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content neumorphic-card">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="close-button" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    ${actions ? `<div class="modal-actions" style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">${actions}</div>` : ''}
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
            
            document.getElementById('modal-container').appendChild(modal);
            return modal;
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            // Reset editing states
            editingMaterialId = null;
            editingWarehouseItemId = null;
        }

        // Warehouse management
        function renderWarehouseItems() {
            const container = document.getElementById('warehouse-items');
            
            if (warehouseItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="icon">üì¶</div>
                        <p>–°–∫–ª–∞–¥ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = warehouseItems.map(item => {
                const isLowStock = item.currentStock <= item.minStock;
                return `
                    <div class="neumorphic-card card animate-fadeIn ${isLowStock ? 'status-low' : ''}">
                        <div class="card-header">
                            <h3 class="font-medium text-lg">${item.name}</h3>
                            <div class="flex gap-1">
                                <button class="neumorphic-button" onclick="editWarehouseItem('${item.id}')">‚úèÔ∏è</button>
                                <button class="neumorphic-button destructive-button" onclick="deleteWarehouseItem('${item.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="grid gap-2 text-sm mb-4">
                            <div class="flex justify-between">
                                <span class="text-muted">–¢–∏–ø:</span>
                                <span>${item.type === 'liquid' ? '–ñ–∏–¥–∫–æ—Å—Ç—å' : item.type === 'piece' ? '–®—Ç—É–∫–∞' : '–í–µ—Å'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-muted">–û–±—ä–µ–º —É–ø–∞–∫–æ–≤–∫–∏:</span>
                                <span>${item.totalVolume} ${getUnitLabel(item.type)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏:</span>
                                <span>${formatCurrency(item.totalCost)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-muted">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                                <span class="text-primary font-medium">${formatCurrency(item.unitCost)}/${getUnitLabel(item.type)}</span>
                            </div>
                        </div>
                        <div class="grid gap-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-muted">–û—Å—Ç–∞—Ç–æ–∫:</span>
                                <span class="text-sm font-medium ${isLowStock ? 'text-destructive' : ''}">${item.currentStock} ${getUnitLabel(item.type)}</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="number" value="${item.currentStock}" 
                                       onchange="updateStock('${item.id}', this.value)" 
                                       class="neumorphic-input text-sm" style="height: 2rem;">
                            </div>
                            ${isLowStock ? '<p class="text-xs text-destructive">–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è!</p>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddWarehouseItemModal() {
            editingWarehouseItemId = null;
            const content = `
                <div class="grid gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <input type="text" id="warehouse-name" class="neumorphic-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <select id="warehouse-type" class="select">
                                <option value="liquid">–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                                <option value="piece">–®—Ç—É–∫–∞</option>
                                <option value="weight">–í–µ—Å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–û–±—ä–µ–º/–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ</label>
                            <input type="number" id="warehouse-volume" class="neumorphic-input" placeholder="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏</label>
                            <input type="number" id="warehouse-cost" class="neumorphic-input" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="warehouse-stock" class="neumorphic-input" placeholder="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="warehouse-min-stock" class="neumorphic-input" placeholder="0" step="0.01">
                        </div>
                    </div>
                    <div id="warehouse-unit-cost" class="text-sm text-muted"></div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveWarehouseItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;

            showModal('–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª', content, actions);

            // Add event listeners for real-time calculation
            document.getElementById('warehouse-volume').addEventListener('input', updateWarehouseUnitCost);
            document.getElementById('warehouse-cost').addEventListener('input', updateWarehouseUnitCost);
        }

        function editWarehouseItem(id) {
            const item = warehouseItems.find(item => item.id === id);
            if (!item) return;

            editingWarehouseItemId = id;
            const content = `
                <div class="grid gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <input type="text" id="warehouse-name" class="neumorphic-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" value="${item.name}">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <select id="warehouse-type" class="select">
                                <option value="liquid" ${item.type === 'liquid' ? 'selected' : ''}>–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                                <option value="piece" ${item.type === 'piece' ? 'selected' : ''}>–®—Ç—É–∫–∞</option>
                                <option value="weight" ${item.type === 'weight' ? 'selected' : ''}>–í–µ—Å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–û–±—ä–µ–º/–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ</label>
                            <input type="number" id="warehouse-volume" class="neumorphic-input" placeholder="0" step="0.01" value="${item.totalVolume}">
                        </div>
                        <div class="form-group">
                            <label class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏</label>
                            <input type="number" id="warehouse-cost" class="neumorphic-input" placeholder="0.00" step="0.01" value="${item.totalCost}">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="warehouse-stock" class="neumorphic-input" placeholder="0" step="0.01" value="${item.currentStock}">
                        </div>
                        <div class="form-group">
                            <label class="label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="warehouse-min-stock" class="neumorphic-input" placeholder="0" step="0.01" value="${item.minStock}">
                        </div>
                    </div>
                    <div id="warehouse-unit-cost" class="text-sm text-muted"></div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveWarehouseItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;

            showModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª', content, actions);

            // Add event listeners for real-time calculation
            document.getElementById('warehouse-volume').addEventListener('input', updateWarehouseUnitCost);
            document.getElementById('warehouse-cost').addEventListener('input', updateWarehouseUnitCost);
            updateWarehouseUnitCost();
        }

        function updateWarehouseUnitCost() {
            const volume = parseFloat(document.getElementById('warehouse-volume').value) || 0;
            const cost = parseFloat(document.getElementById('warehouse-cost').value) || 0;
            const unitCost = volume > 0 ? cost / volume : 0;
            
            document.getElementById('warehouse-unit-cost').textContent = 
                volume > 0 && cost > 0 ? `–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: ${formatCurrency(unitCost)}` : '';
        }

        function saveWarehouseItem() {
            const name = document.getElementById('warehouse-name').value;
            const type = document.getElementById('warehouse-type').value;
            const totalVolume = parseFloat(document.getElementById('warehouse-volume').value) || 0;
            const totalCost = parseFloat(document.getElementById('warehouse-cost').value) || 0;
            const currentStock = parseFloat(document.getElementById('warehouse-stock').value) || 0;
            const minStock = parseFloat(document.getElementById('warehouse-min-stock').value) || 0;

            if (!name || totalVolume <= 0 || totalCost <= 0) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            const unitCost = totalCost / totalVolume;
            
            if (editingWarehouseItemId) {
                // Update existing item
                const itemIndex = warehouseItems.findIndex(item => item.id === editingWarehouseItemId);
                if (itemIndex !== -1) {
                    warehouseItems[itemIndex] = {
                        ...warehouseItems[itemIndex],
                        name,
                        type,
                        totalVolume,
                        totalCost,
                        unitCost,
                        currentStock,
                        minStock
                    };
                }
            } else {
                // Add new item
                const item = {
                    id: Date.now().toString(),
                    name,
                    type,
                    totalVolume,
                    totalCost,
                    unitCost,
                    currentStock,
                    minStock
                };
                warehouseItems.push(item);
            }

            localStorage.setItem('warehouse-items', JSON.stringify(warehouseItems));
            renderWarehouseItems();
            renderAvailableMaterials();
            closeModal();
            showToast(editingWarehouseItemId ? '–ú–∞—Ç–µ—Ä–∏–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥', 'success');
        }

        function updateStock(id, newStock) {
            const item = warehouseItems.find(item => item.id === id);
            if (item) {
                item.currentStock = parseFloat(newStock) || 0;
                localStorage.setItem('warehouse-items', JSON.stringify(warehouseItems));
                renderWarehouseItems();
                renderAvailableMaterials();
            }
        }

        function deleteWarehouseItem(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —Å–æ —Å–∫–ª–∞–¥–∞?')) {
                warehouseItems = warehouseItems.filter(item => item.id !== id);
                localStorage.setItem('warehouse-items', JSON.stringify(warehouseItems));
                renderWarehouseItems();
                renderAvailableMaterials();
                showToast('–ú–∞—Ç–µ—Ä–∏–∞–ª —É–¥–∞–ª–µ–Ω —Å–æ —Å–∫–ª–∞–¥–∞', 'success');
            }
        }

        // Materials management
        function renderMaterials() {
            const container = document.getElementById('materials-list');
            const totalContainer = document.getElementById('materials-total');
            
            if (materials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p>–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.</p>
                    </div>
                `;
                totalContainer.classList.add('hidden');
                return;
            }

            container.innerHTML = materials.map(material => `
                <div class="neumorphic-card card animate-fadeIn">
                    <div class="card-header">
                        <h3 class="font-medium text-lg">${material.name}</h3>
                        <div class="flex gap-1">
                            <button class="neumorphic-button" onclick="editMaterial('${material.id}')">‚úèÔ∏è</button>
                            <button class="neumorphic-button destructive-button" onclick="deleteMaterial('${material.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="grid gap-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-muted">–¢–∏–ø:</span>
                            <span>${material.type === 'liquid' ? '–ñ–∏–¥–∫–æ—Å—Ç—å' : material.type === 'piece' ? '–®—Ç—É–∫–∞' : '–í–µ—Å'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                            <span>${formatCurrency(material.unitPrice)}/${getUnitLabel(material.type)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–†–∞—Å—Ö–æ–¥:</span>
                            <span>${material.consumption} ${getUnitLabel(material.type)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–ù–∞–¥–±–∞–≤–∫–∞:</span>
                            <span>${material.markupType === 'percentage' ? `${material.markup}%` : formatCurrency(material.markup)}</span>
                        </div>
                        <div class="flex justify-between font-medium text-primary" style="border-top: 1px solid var(--border); padding-top: 0.5rem;">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>${formatCurrency(material.totalCost)}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            const totalSum = materials.reduce((sum, material) => sum + material.totalCost, 0);
            document.getElementById('materials-total-amount').textContent = formatCurrency(totalSum);
            totalContainer.classList.remove('hidden');
        }

        function showAddMaterialModal() {
            editingMaterialId = null;
            const content = `
                <div class="grid gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <input type="text" id="material-name" class="neumorphic-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <select id="material-type" class="select">
                                <option value="liquid">–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                                <option value="piece">–®—Ç—É–∫–∞</option>
                                <option value="weight">–í–µ—Å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                            <input type="number" id="material-price" class="neumorphic-input" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="label">–†–∞—Å—Ö–æ–¥</label>
                            <input type="number" id="material-consumption" class="neumorphic-input" placeholder="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –Ω–∞–¥–±–∞–≤–∫–∏</label>
                            <select id="material-markup-type" class="select">
                                <option value="percentage">–ü—Ä–æ—Ü–µ–Ω—Ç (%)</option>
                                <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–ù–∞–¥–±–∞–≤–∫–∞</label>
                            <input type="number" id="material-markup" class="neumorphic-input" placeholder="0" step="0.01">
                        </div>
                    </div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveMaterial()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;

            showModal('–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª', content, actions);
        }

        function editMaterial(id) {
            const material = materials.find(m => m.id === id);
            if (!material) return;

            editingMaterialId = id;
            const content = `
                <div class="grid gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <input type="text" id="material-name" class="neumorphic-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" value="${material.name}">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</label>
                            <select id="material-type" class="select">
                                <option value="liquid" ${material.type === 'liquid' ? 'selected' : ''}>–ñ–∏–¥–∫–æ—Å—Ç—å</option>
                                <option value="piece" ${material.type === 'piece' ? 'selected' : ''}>–®—Ç—É–∫–∞</option>
                                <option value="weight" ${material.type === 'weight' ? 'selected' : ''}>–í–µ—Å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</label>
                            <input type="number" id="material-price" class="neumorphic-input" placeholder="0.00" step="0.01" value="${material.unitPrice}">
                        </div>
                        <div class="form-group">
                            <label class="label">–†–∞—Å—Ö–æ–¥</label>
                            <input type="number" id="material-consumption" class="neumorphic-input" placeholder="0" step="0.01" value="${material.consumption}">
                        </div>
                        <div class="form-group">
                            <label class="label">–¢–∏–ø –Ω–∞–¥–±–∞–≤–∫–∏</label>
                            <select id="material-markup-type" class="select">
                                <option value="percentage" ${material.markupType === 'percentage' ? 'selected' : ''}>–ü—Ä–æ—Ü–µ–Ω—Ç (%)</option>
                                <option value="fixed" ${material.markupType === 'fixed' ? 'selected' : ''}>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="label">–ù–∞–¥–±–∞–≤–∫–∞</label>
                            <input type="number" id="material-markup" class="neumorphic-input" placeholder="0" step="0.01" value="${material.markup}">
                        </div>
                    </div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveMaterial()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;

            showModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª', content, actions);
        }

        function saveMaterial() {
            const name = document.getElementById('material-name').value;
            const type = document.getElementById('material-type').value;
            const unitPrice = parseFloat(document.getElementById('material-price').value) || 0;
            const consumption = parseFloat(document.getElementById('material-consumption').value) || 0;
            const markupType = document.getElementById('material-markup-type').value;
            const markup = parseFloat(document.getElementById('material-markup').value) || 0;

            if (!name || unitPrice <= 0 || consumption <= 0) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            const baseConsumptionCost = unitPrice * consumption;
            const totalCost = markupType === 'percentage' 
                ? baseConsumptionCost * (1 + markup / 100)
                : baseConsumptionCost + markup;

            if (editingMaterialId) {
                // Update existing material
                const materialIndex = materials.findIndex(m => m.id === editingMaterialId);
                if (materialIndex !== -1) {
                    materials[materialIndex] = {
                        ...materials[materialIndex],
                        name,
                        type,
                        unitPrice,
                        consumption,
                        markupType,
                        markup,
                        totalCost
                    };
                }
            } else {
                // Add new material
                const material = {
                    id: Date.now().toString(),
                    name,
                    type,
                    unitPrice,
                    consumption,
                    markupType,
                    markup,
                    totalCost
                };
                materials.push(material);
            }

            localStorage.setItem('materials', JSON.stringify(materials));
            renderMaterials();
            closeModal();
            showToast(editingMaterialId ? '–ú–∞—Ç–µ—Ä–∏–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }

        function deleteMaterial(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞?')) {
                materials = materials.filter(material => material.id !== id);
                localStorage.setItem('materials', JSON.stringify(materials));
                renderMaterials();
                showToast('–ú–∞—Ç–µ—Ä–∏–∞–ª —É–¥–∞–ª–µ–Ω', 'success');
            }
        }

        function showSaveCalculationModal() {
            if (materials.length === 0) {
                showToast('–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞', 'error');
                return;
            }

            const content = `
                <div class="form-group">
                    <label class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞/—Ä–∞–±–æ—Ç—ã</label>
                    <input type="text" id="calculation-name" class="neumorphic-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞">
                </div>
                <div class="text-sm text-muted">
                    <p>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${formatCurrency(materials.reduce((sum, m) => sum + m.totalCost, 0))}</p>
                    <p>–î–∞—Ç–∞: ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveCalculation()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;

            showModal('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç', content, actions);
        }

        function saveCalculation() {
            const name = document.getElementById('calculation-name').value;
            if (!name) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞', 'error');
                return;
            }

            const calculation = {
                id: Date.now().toString(),
                name,
                date: new Date().toISOString(),
                materials: [...materials],
                totalSum: materials.reduce((sum, material) => sum + material.totalCost, 0)
            };

            calculations.push(calculation);
            localStorage.setItem('calculations', JSON.stringify(calculations));
            renderCalculationsHistory();
            closeModal();
            showToast(`–†–∞—Å—á–µ—Ç "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω`, 'success');
        }

        // Repair management
        function renderAvailableMaterials() {
            const container = document.getElementById('available-materials');
            const availableItems = warehouseItems.filter(item => 
                item.currentStock > 0 && 
                !currentRepair.materials.some(m => m.warehouseItemId === item.id)
            );

            if (availableItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted" style="grid-column: 1 / -1; padding: 2rem;">
                        –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ –∏–ª–∏ –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                    </div>
                `;
                return;
            }

            container.innerHTML = availableItems.map(item => `
                <button class="neumorphic-button" onclick="addMaterialToRepair('${item.id}')" 
                        style="height: auto; padding: 1rem; text-align: left;">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">${item.name}</span>
                        <span>‚ûï</span>
                    </div>
                    <div class="text-xs text-muted">
                        <p>–û—Å—Ç–∞—Ç–æ–∫: ${item.currentStock} ${getUnitLabel(item.type)}</p>
                        <p>–¶–µ–Ω–∞: ${formatCurrency(item.unitCost)}/${getUnitLabel(item.type)}</p>
                    </div>
                </button>
            `).join('');
        }

        function addMaterialToRepair(warehouseItemId) {
            const warehouseItem = warehouseItems.find(item => item.id === warehouseItemId);
            if (!warehouseItem) return;

            const existingMaterial = currentRepair.materials.find(m => m.warehouseItemId === warehouseItemId);
            if (existingMaterial) {
                showToast('–ú–∞—Ç–µ—Ä–∏–∞–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–µ–º–æ–Ω—Ç', 'error');
                return;
            }

            const newMaterial = {
                id: Date.now().toString(),
                warehouseItemId: warehouseItem.id,
                name: warehouseItem.name,
                unitCost: warehouseItem.unitCost,
                usedAmount: 0,
                totalCost: 0,
                type: warehouseItem.type
            };

            currentRepair.materials.push(newMaterial);
            renderSelectedMaterials();
            renderAvailableMaterials();
            updateRepairTotals();
        }

        function renderSelectedMaterials() {
            const container = document.getElementById('selected-materials');
            const section = document.getElementById('selected-materials-section');

            if (currentRepair.materials.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            container.innerHTML = currentRepair.materials.map(material => {
                const warehouseItem = warehouseItems.find(item => item.id === material.warehouseItemId);
                const maxAmount = warehouseItem ? warehouseItem.currentStock : 0;

                return `
                    <div class="neumorphic-card" style="padding: 1rem; border: 1px solid var(--border);">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-medium">${material.name}</h4>
                                <p class="text-sm text-muted">–¶–µ–Ω–∞: ${formatCurrency(material.unitCost)}/${getUnitLabel(material.type)}</p>
                                <p class="text-sm text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: ${maxAmount} ${getUnitLabel(material.type)}</p>
                            </div>
                            <button class="neumorphic-button destructive-button" onclick="removeMaterialFromRepair('${material.id}')">üóëÔ∏è</button>
                        </div>
                        <div class="flex items-center gap-3">
                            <div style="flex: 1;">
                                <label class="label text-sm">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (${getUnitLabel(material.type)})</label>
                                <input type="number" value="${material.usedAmount}" 
                                       onchange="updateMaterialAmount('${material.id}', this.value)"
                                       max="${maxAmount}" placeholder="0" class="neumorphic-input" style="margin-top: 0.25rem;">
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å</p>
                                <p class="font-medium text-primary">${formatCurrency(material.totalCost)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateMaterialAmount(materialId, amount) {
            const material = currentRepair.materials.find(m => m.id === materialId);
            const warehouseItem = warehouseItems.find(item => item.id === material.warehouseItemId);
            
            if (material && warehouseItem) {
                const newAmount = Math.min(parseFloat(amount) || 0, warehouseItem.currentStock);
                material.usedAmount = newAmount;
                material.totalCost = newAmount * material.unitCost;
                renderSelectedMaterials();
                updateRepairTotals();
            }
        }

        function removeMaterialFromRepair(materialId) {
            currentRepair.materials = currentRepair.materials.filter(m => m.id !== materialId);
            renderSelectedMaterials();
            renderAvailableMaterials();
            updateRepairTotals();
        }

        function updateRepairTotals() {
            const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
            const totalMaterialsCost = currentRepair.materials.reduce((sum, material) => sum + material.totalCost, 0);
            const totalCost = totalMaterialsCost + laborCost;

            currentRepair.laborCost = laborCost;
            currentRepair.totalMaterialsCost = totalMaterialsCost;
            currentRepair.totalCost = totalCost;

            document.getElementById('total-materials-cost').textContent = formatCurrency(totalMaterialsCost);
            document.getElementById('total-labor-cost').textContent = formatCurrency(laborCost);
            document.getElementById('total-repair-cost').textContent = formatCurrency(totalCost);

            const totalSection = document.getElementById('total-cost-section');
            if (totalMaterialsCost > 0 || laborCost > 0) {
                totalSection.classList.remove('hidden');
            } else {
                totalSection.classList.add('hidden');
            }
        }

        function clearRepair() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç–∞?')) {
                currentRepair = {
                    clientName: '',
                    carInfo: '',
                    description: '',
                    materials: [],
                    laborCost: 0,
                    totalMaterialsCost: 0,
                    totalCost: 0
                };

                document.getElementById('client-name').value = '';
                document.getElementById('car-info').value = '';
                document.getElementById('repair-description').value = '';
                document.getElementById('labor-cost').value = '';

                renderSelectedMaterials();
                renderAvailableMaterials();
                updateRepairTotals();
                showToast('–†–∞—Å—á–µ—Ç –æ—á–∏—â–µ–Ω', 'success');
            }
        }

        function saveRepair() {
            const clientName = document.getElementById('client-name').value;
            const carInfo = document.getElementById('car-info').value;
            const description = document.getElementById('repair-description').value;

            if (!clientName || currentRepair.materials.length === 0) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', 'error');
                return;
            }

            // Update warehouse stock
            currentRepair.materials.forEach(material => {
                const warehouseItem = warehouseItems.find(item => item.id === material.warehouseItemId);
                if (warehouseItem) {
                    warehouseItem.currentStock = Math.max(0, warehouseItem.currentStock - material.usedAmount);
                }
            });

            const repair = {
                id: Date.now().toString(),
                clientName,
                carInfo,
                description,
                materials: [...currentRepair.materials],
                laborCost: currentRepair.laborCost,
                totalMaterialsCost: currentRepair.totalMaterialsCost,
                totalCost: currentRepair.totalCost,
                date: new Date().toISOString(),
                status: 'completed'
            };

            repairs.push(repair);
            localStorage.setItem('repairs', JSON.stringify(repairs));
            localStorage.setItem('warehouse-items', JSON.stringify(warehouseItems));

            renderRepairsHistory();
            renderWarehouseItems();
            clearRepair();
            showToast('–†–µ–º–æ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –æ—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }

        function showReceiptModal() {
            const clientName = document.getElementById('client-name').value || '–ö–ª–∏–µ–Ω—Ç';
            const carInfo = document.getElementById('car-info').value;
            const description = document.getElementById('repair-description').value;

            const content = `
                <div class="print-content" style="font-family: monospace; max-width: 400px;">
                    <div class="text-center" style="border-bottom: 2px solid var(--border); padding-bottom: 1rem; margin-bottom: 1rem;">
                        <h3 class="font-bold">–ê–≤—Ç–æ–°–µ—Ä–≤–∏—Å</h3>
                        <p class="text-sm text-muted">–ß–µ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</p>
                        <p class="text-xs text-muted">${new Date().toLocaleString()}</p>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <p class="text-sm"><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${clientName}</p>
                        ${carInfo ? `<p class="text-sm"><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${carInfo}</p>` : ''}
                        ${description ? `<p class="text-sm"><strong>–†–∞–±–æ—Ç—ã:</strong> ${description}</p>` : ''}
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <h4 class="font-medium mb-2">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h4>
                        ${currentRepair.materials.map(material => `
                            <div class="flex justify-between text-sm" style="margin-bottom: 0.25rem;">
                                <span>${material.name} x${material.usedAmount}</span>
                                <span>${formatCurrency(material.totalCost)}</span>
                            </div>
                        `).join('')}
                        ${currentRepair.laborCost > 0 ? `
                            <div class="flex justify-between text-sm" style="border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span>–†–∞–±–æ—Ç—ã</span>
                                <span>${formatCurrency(currentRepair.laborCost)}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div style="border-top: 2px solid var(--border); padding-top: 0.5rem;">
                        <div class="flex justify-between font-bold">
                            <span>–ò–¢–û–ì–û:</span>
                            <span>${formatCurrency(currentRepair.totalCost)}</span>
                        </div>
                    </div>

                    <div class="text-center text-xs text-muted" style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!</p>
                        <p>–ê–≤—Ç–æ–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–æ–≤</p>
                    </div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="printReceipt()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                <button class="neumorphic-button" onclick="downloadReceipt()">üíæ –°–∫–∞—á–∞—Ç—å</button>
                <button class="neumorphic-button" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;

            showModal('–ß–µ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç', content, actions);
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            const clientName = document.getElementById('client-name').value || '–ö–ª–∏–µ–Ω—Ç';
            const receiptHTML = generateReceiptHTML();
            const blob = new Blob([receiptHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt-${clientName}-${new Date().toLocaleDateString()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('–ß–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        }

        function generateReceiptHTML() {
            const clientName = document.getElementById('client-name').value || '–ö–ª–∏–µ–Ω—Ç';
            const carInfo = document.getElementById('car-info').value;
            const description = document.getElementById('repair-description').value;

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–ß–µ–∫ - ${clientName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                        .client-info { margin-bottom: 20px; }
                        .materials { margin-bottom: 20px; }
                        .material-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .total { border-top: 2px solid #000; padding-top: 10px; font-weight: bold; font-size: 18px; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
                    </style>
                
<script>
  if (window.matchMedia('(display-mode: standalone)').matches && location.pathname.endsWith('/')) {
    location.replace(location.pathname + 'index.html');
  }
</script>

</head>
                <body>
                    <div class="header">
                        <h2>–ê–≤—Ç–æ–°–µ—Ä–≤–∏—Å</h2>
                        <p>–ß–µ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</p>
                        <p>${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div class="client-info">
                        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${clientName}</p>
                        ${carInfo ? `<p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${carInfo}</p>` : ''}
                        ${description ? `<p><strong>–†–∞–±–æ—Ç—ã:</strong> ${description}</p>` : ''}
                    </div>
                    
                    <div class="materials">
                        <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h3>
                        ${currentRepair.materials.map(material => `
                            <div class="material-item">
                                <span>${material.name} x${material.usedAmount}</span>
                                <span>${formatCurrency(material.totalCost)}</span>
                            </div>
                        `).join('')}
                        ${currentRepair.laborCost > 0 ? `
                            <div class="material-item" style="border-top: 1px solid #ccc; padding-top: 5px; margin-top: 10px;">
                                <span>–†–∞–±–æ—Ç—ã</span>
                                <span>${formatCurrency(currentRepair.laborCost)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="total">
                        <div style="display: flex; justify-content: space-between;">
                            <span>–ò–¢–û–ì–û:</span>
                            <span>${formatCurrency(currentRepair.totalCost)}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!</p>
                        <p>–ê–≤—Ç–æ–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–æ–≤</p>
                    </div>
                </body>
                </html>
            `;
        }

        // History management
        function renderCalculationsHistory() {
            const container = document.getElementById('calculations-history');
            
            if (calculations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –ø—É—Å—Ç–∞.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = calculations.map(calculation => `
                <div class="neumorphic-card card animate-fadeIn">
                    <div class="card-header">
                        <h4 class="font-medium text-lg">${calculation.name}</h4>
                        <div class="flex gap-1">
                            <button class="neumorphic-button" onclick="viewCalculation('${calculation.id}')">üëÅÔ∏è</button>
                            <button class="neumorphic-button destructive-button" onclick="deleteCalculation('${calculation.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="grid gap-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-muted">–î–∞—Ç–∞:</span>
                            <span>${formatDate(calculation.date)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:</span>
                            <span>${calculation.materials.length}</span>
                        </div>
                        <div class="flex justify-between font-medium text-primary" style="border-top: 1px solid var(--border); padding-top: 0.5rem;">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>${formatCurrency(calculation.totalSum)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRepairsHistory() {
            const container = document.getElementById('repairs-history');
            
            if (repairs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <p>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–æ–≤ –ø—É—Å—Ç–∞.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = repairs.map(repair => `
                <div class="neumorphic-card card animate-fadeIn">
                    <div class="card-header">
                        <h4 class="font-medium text-lg">${repair.clientName}</h4>
                        <div class="flex gap-1">
                            <button class="neumorphic-button" onclick="viewRepair('${repair.id}')">üëÅÔ∏è</button>
                            <button class="neumorphic-button" onclick="printRepairReceipt('${repair.id}')">üñ®Ô∏è</button>
                            <button class="neumorphic-button" onclick="downloadRepairReceipt('${repair.id}')">üíæ</button>
                            <button class="neumorphic-button destructive-button" onclick="deleteRepair('${repair.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="grid gap-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-muted">–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</span>
                            <span>${repair.carInfo || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–î–∞—Ç–∞:</span>
                            <span>${formatDate(repair.date)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:</span>
                            <span>${repair.materials.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</span>
                            <span>${formatCurrency(repair.totalMaterialsCost)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted">–†–∞–±–æ—Ç—ã:</span>
                            <span>${formatCurrency(repair.laborCost)}</span>
                        </div>
                        <div class="flex justify-between font-medium text-primary" style="border-top: 1px solid var(--border); padding-top: 0.5rem;">
                            <span>–ò—Ç–æ–≥–æ:</span>
                            <span>${formatCurrency(repair.totalCost)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewRepair(repairId) {
            const repair = repairs.find(r => r.id === repairId);
            if (!repair) return;

            const content = `
                <div class="grid gap-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h4>
                            <div class="grid gap-1 text-sm">
                                <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${repair.clientName}</p>
                                <p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${repair.carInfo || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–î–∞—Ç–∞:</strong> ${formatDate(repair.date)}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h4>
                            <div class="grid gap-1 text-sm">
                                <div class="flex justify-between">
                                    <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</span>
                                    <span>${formatCurrency(repair.totalMaterialsCost)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>–†–∞–±–æ—Ç—ã:</span>
                                    <span>${formatCurrency(repair.laborCost)}</span>
                                </div>
                                <div class="flex justify-between font-bold text-primary" style="border-top: 1px solid var(--border); padding-top: 0.25rem;">
                                    <span>–ò—Ç–æ–≥–æ:</span>
                                    <span>${formatCurrency(repair.totalCost)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${repair.description ? `
                        <div>
                            <h4 class="font-medium mb-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</h4>
                            <p class="text-sm neumorphic-card" style="padding: 0.75rem; background: var(--muted);">${repair.description}</p>
                        </div>
                    ` : ''}

                    <div>
                        <h4 class="font-medium mb-4">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
                        <div class="grid gap-3">
                            ${repair.materials.map(material => `
                                <div class="neumorphic-card" style="padding: 1rem; border: 1px solid var(--border);">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">${material.name}</span>
                                        <span class="text-primary font-medium">${formatCurrency(material.totalCost)}</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 text-sm">
                                        <div>
                                            <span class="text-muted">–¢–∏–ø: </span>
                                            <span>${material.type === 'liquid' ? '–ñ–∏–¥–∫–æ—Å—Ç—å' : material.type === 'piece' ? '–®—Ç—É–∫–∞' : '–í–µ—Å'}</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: </span>
                                            <span>${material.usedAmount} ${getUnitLabel(material.type)}</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">–¶–µ–Ω–∞ –∑–∞ –µ–¥.: </span>
                                            <span>${formatCurrency(material.unitCost)}</span>
                                        </div>
                                        <div>
                                            <span class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å: </span>
                                            <span class="font-medium">${formatCurrency(material.totalCost)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="printRepairReceipt('${repair.id}')">üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>
                <button class="neumorphic-button" onclick="downloadRepairReceipt('${repair.id}')">üíæ –°–∫–∞—á–∞—Ç—å —á–µ–∫</button>
                <button class="neumorphic-button" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;

            showModal('–î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞', content, actions);
        }

        function printRepairReceipt(repairId) {
            const repair = repairs.find(r => r.id === repairId);
            if (!repair) return;

            const printWindow = window.open('', '_blank');
            const receiptHTML = generateRepairReceiptHTML(repair);
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function downloadRepairReceipt(repairId) {
            const repair = repairs.find(r => r.id === repairId);
            if (!repair) return;

            const receiptHTML = generateRepairReceiptHTML(repair);
            const blob = new Blob([receiptHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt-${repair.clientName}-${new Date(repair.date).toLocaleDateString()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('–ß–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        }

        function generateRepairReceiptHTML(repair) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–ß–µ–∫ - ${repair.clientName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                        .client-info { margin-bottom: 20px; }
                        .materials { margin-bottom: 20px; }
                        .material-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .total { border-top: 2px solid #000; padding-top: 10px; font-weight: bold; font-size: 18px; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
                    </style>
                
<script>
  if (window.matchMedia('(display-mode: standalone)').matches && location.pathname.endsWith('/')) {
    location.replace(location.pathname + 'index.html');
  }
</script>

</head>
                <body>
                    <div class="header">
                        <h2>–ê–≤—Ç–æ–°–µ—Ä–≤–∏—Å</h2>
                        <p>–ß–µ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</p>
                        <p>${formatDate(repair.date)}</p>
                    </div>
                    
                    <div class="client-info">
                        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${repair.clientName}</p>
                        ${repair.carInfo ? `<p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${repair.carInfo}</p>` : ''}
                        ${repair.description ? `<p><strong>–†–∞–±–æ—Ç—ã:</strong> ${repair.description}</p>` : ''}
                    </div>
                    
                    <div class="materials">
                        <h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</h3>
                        ${repair.materials.map(material => `
                            <div class="material-item">
                                <span>${material.name} x${material.usedAmount}</span>
                                <span>${formatCurrency(material.totalCost)}</span>
                            </div>
                        `).join('')}
                        ${repair.laborCost > 0 ? `
                            <div class="material-item" style="border-top: 1px solid #ccc; padding-top: 5px; margin-top: 10px;">
                                <span>–†–∞–±–æ—Ç—ã</span>
                                <span>${formatCurrency(repair.laborCost)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="total">
                        <div style="display: flex; justify-content: space-between;">
                            <span>–ò–¢–û–ì–û:</span>
                            <span>${formatCurrency(repair.totalCost)}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!</p>
                        <p>–ê–≤—Ç–æ–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–æ–≤</p>
                    </div>
                </body>
                </html>
            `;
        }

        function deleteRepair(repairId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–º–æ–Ω—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?')) {
                repairs = repairs.filter(repair => repair.id !== repairId);
                localStorage.setItem('repairs', JSON.stringify(repairs));
                renderRepairsHistory();
                updateFinanceOverview();
                showToast('–†–µ–º–æ–Ω—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏', 'success');
            }
        }

        function deleteCalculation(calculationId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?')) {
                calculations = calculations.filter(calc => calc.id !== calculationId);
                localStorage.setItem('calculations', JSON.stringify(calculations));
                renderCalculationsHistory();
                showToast('–†–∞—Å—á–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏', 'success');
            }
        }

        // Finance management
        function updateFinanceOverview() {
            const monthTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getMonth() === currentMonth.getMonth() && 
                       transactionDate.getFullYear() === currentMonth.getFullYear();
            });

            const totalIncome = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = monthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const profit = totalIncome - totalExpenses;

            document.getElementById('monthly-income').textContent = formatCurrency(totalIncome);
            document.getElementById('monthly-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('monthly-profit').textContent = formatCurrency(profit);
            document.getElementById('monthly-profit').className = `text-2xl font-bold ${profit >= 0 ? 'text-green' : 'text-red'}`;
            document.getElementById('monthly-transactions').textContent = monthTransactions.length;

            updateCurrentMonthDisplay();
            updateCategoryStats();
            updateDailyTransactions();
        }

        function updateCurrentMonthDisplay() {
            const monthNames = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];
            document.getElementById('current-month').textContent = 
                `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }

        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            updateFinanceOverview();
            renderCalendar();
        }

        function updateCategoryStats() {
            const monthTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.getMonth() === currentMonth.getMonth() && 
                       transactionDate.getFullYear() === currentMonth.getFullYear();
            });

            const incomeByCategory = {};
            const expensesByCategory = {};

            monthTransactions.forEach(t => {
                if (t.type === 'income') {
                    incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
                } else {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                }
            });

            const container = document.getElementById('category-stats');
            container.innerHTML = `
                <div>
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        üìä –î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                    </h4>
                    <div class="grid gap-2">
                        ${Object.entries(incomeByCategory).map(([category, amount]) => `
                            <div class="flex justify-between items-center neumorphic-card" style="padding: 0.5rem;">
                                <span class="text-sm">${category}</span>
                                <span class="font-medium text-green">${formatCurrency(amount)}</span>
                            </div>
                        `).join('') || '<p class="text-sm text-muted text-center" style="padding: 1rem;">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>'}
                    </div>
                </div>
                <div>
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        üìâ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                    </h4>
                    <div class="grid gap-2">
                        ${Object.entries(expensesByCategory).map(([category, amount]) => `
                            <div class="flex justify-between items-center neumorphic-card" style="padding: 0.5rem;">
                                <span class="text-sm">${category}</span>
                                <span class="font-medium text-red">${formatCurrency(amount)}</span>
                            </div>
                        `).join('') || '<p class="text-sm text-muted text-center" style="padding: 1rem;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>'}
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-grid');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            let calendarHTML = '';

            // Header
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day" style="font-weight: 600; color: var(--muted-foreground);">${day}</div>`;
            });

            // Days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = currentDate.toDateString() === new Date().toDateString();
                const isSelected = currentDate.toDateString() === selectedDate.toDateString();
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (!isCurrentMonth) classes += ' text-muted';

                calendarHTML += `
                    <div class="${classes}" onclick="selectDate(new Date(${currentDate.getTime()}))" 
                         style="${!isCurrentMonth ? 'opacity: 0.3;' : ''}">
                        ${currentDate.getDate()}
                    </div>
                `;
            }

            container.innerHTML = calendarHTML;
            updateSelectedDateDisplay();
        }

        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            updateDailyTransactions();
        }

        function updateSelectedDateDisplay() {
            document.getElementById('selected-date-display').textContent = 
                selectedDate.toLocaleDateString('ru-RU', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
        }

        function updateDailyTransactions() {
            const dailyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate.toDateString() === selectedDate.toDateString();
            });

            const container = document.getElementById('daily-transactions');
            
            if (dailyTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted" style="padding: 2rem;">
                        –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
                    </div>
                `;
                return;
            }

            container.innerHTML = dailyTransactions.map(transaction => `
                <div class="neumorphic-card" style="padding: 0.75rem;">
                    <div class="flex justify-between items-start mb-2">
                        <div style="flex: 1;">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="badge ${transaction.type === 'income' ? 'badge-income' : 'badge-expense'}">
                                    ${transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}
                                </span>
                                <span class="text-sm text-muted">${transaction.category}</span>
                            </div>
                            <p class="text-sm">${transaction.description}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-medium ${transaction.type === 'income' ? 'text-green' : 'text-red'}">
                                ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                            </span>
                            ${!transaction.repairId ? `
                                <div class="flex gap-1">
                                    <button class="neumorphic-button" onclick="editTransaction('${transaction.id}')" style="padding: 0.25rem; font-size: 0.75rem;">‚úèÔ∏è</button>
                                    <button class="neumorphic-button destructive-button" onclick="deleteTransaction('${transaction.id}')" style="padding: 0.25rem; font-size: 0.75rem;">üóëÔ∏è</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddTransactionModal() {
            const content = `
                <div class="grid gap-4">
                    <div class="form-group">
                        <label class="label">–¢–∏–ø</label>
                        <select id="transaction-type" class="select" onchange="updateTransactionCategories()">
                            <option value="income">–î–æ—Ö–æ–¥</option>
                            <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="transaction-category" class="select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">–°—É–º–º–∞</label>
                        <input type="number" id="transaction-amount" class="neumorphic-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="label">–î–∞—Ç–∞</label>
                        <input type="date" id="transaction-date" class="neumorphic-input" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="transaction-description" class="textarea" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" rows="3"></textarea>
                    </div>
                </div>
            `;

            const actions = `
                <button class="neumorphic-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="neumorphic-button primary-button" onclick="saveTransaction()">–î–æ–±–∞–≤–∏—Ç—å</button>
            `;

            showModal('–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é', content, actions);
            updateTransactionCategories();
        }

        function updateTransactionCategories() {
            const type = document.getElementById('transaction-type').value;
            const categorySelect = document.getElementById('transaction-category');
            
            const incomeCategories = [
                '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π',
                '–ü–æ–∫—Ä–∞—Å–∫–∞',
                '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
                '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
                '–ü—Ä–æ–¥–∞–∂–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π',
                '–ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã'
            ];

            const expenseCategories = [
                '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
                '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
                '–ê—Ä–µ–Ω–¥–∞',
                '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
                '–†–µ–∫–ª–∞–º–∞',
                '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
                '–ù–∞–ª–æ–≥–∏',
                '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã'
            ];

            const categories = type === 'income' ? incomeCategories : expenseCategories;
            
            categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function saveTransaction() {
            const type = document.getElementById('transaction-type').value;
            const category = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
            const date = document.getElementById('transaction-date').value;
            const description = document.getElementById('transaction-description').value;

            if (!category || amount <= 0) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            const transaction = {
                id: Date.now().toString(),
                type,
                category,
                amount,
                description,
                date: new Date(date).toISOString()
            };

            transactions.push(transaction);
            localStorage.setItem('finance-transactions', JSON.stringify(transactions));
            updateFinanceOverview();
            closeModal();
            showToast(`${type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
        }

        function deleteTransaction(transactionId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) {
                transactions = transactions.filter(t => t.id !== transactionId);
                localStorage.setItem('finance-transactions', JSON.stringify(transactions));
                updateFinanceOverview();
                showToast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
            }
        }

        function importRepairIncome() {
            const existingRepairIds = transactions
                .filter(t => t.repairId)
                .map(t => t.repairId);

            const newIncomeTransactions = repairs
                .filter(repair => !existingRepairIds.includes(repair.id))
                .map(repair => ({
                    id: `repair-${repair.id}`,
                    type: 'income',
                    category: '–†–µ–º–æ–Ω—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π',
                    amount: repair.totalCost,
                    description: `–†–µ–º–æ–Ω—Ç –¥–ª—è ${repair.clientName} (${repair.carInfo || '–∞–≤—Ç–æ–º–æ–±–∏–ª—å'})`,
                    date: repair.date,
                    source: 'repair',
                    repairId: repair.id
                }));

            if (newIncomeTransactions.length > 0) {
                transactions.push(...newIncomeTransactions);
                localStorage.setItem('finance-transactions', JSON.stringify(transactions));
                updateFinanceOverview();
                showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${newIncomeTransactions.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ä–µ–º–æ–Ω—Ç–æ–≤`, 'success');
            } else {
                showToast('–ù–µ—Ç –Ω–æ–≤—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'info');
            }
        }

        // Event listeners
        document.getElementById('labor-cost').addEventListener('input', updateRepairTotals);

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
